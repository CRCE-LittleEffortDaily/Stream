<script>

///// ========== 原本 Timer 的變數與函式（先宣告） ========== /////
let timer = null;
let remaining = 0;

function updateDisplay() {
    let total = remaining;

    let days = Math.floor(total / 86400);
    total %= 86400;

    let hours = Math.floor(total / 3600);
    total %= 3600;

    let mins = Math.floor(total / 60);
    let secs = total % 60;

    const showDays  = document.getElementById("show-days").checked;
    const showHours = document.getElementById("show-hours").checked;
    const showMins  = document.getElementById("show-mins").checked;
    const showSecs  = document.getElementById("show-secs").checked;

    const parts = [];

    if (showDays)  parts.push(days.toString().padStart(2, '0') + "d");
    if (showHours) parts.push(hours.toString().padStart(2, '0') + "h");
    if (showMins)  parts.push(mins.toString().padStart(2, '0') + "m");
    if (showSecs)  parts.push(secs.toString().padStart(2, '0') + "s");

    const display = document.getElementById("time-display");
    display.style.color = timerColor;   // ← 顏色這裡才生效
    display.innerText = parts.length ? parts.join(" : ") : "--";
}

function startTimer() {
    if (timer) clearInterval(timer);

    timer = setInterval(() => {
        if (remaining > 0) {
            remaining--;
            updateDisplay();
        } else {
            clearInterval(timer);
            timer = null;
        }
    }, 1000);
}

///// ========== URL 參數控制區 ========== /////
const urlParams = new URLSearchParams(window.location.search);

function getBool(name, defaultValue) {
    if (!urlParams.has(name)) return defaultValue;
    return urlParams.get(name) === "1";
}

// 顯示元件控制
document.getElementById("show-days").checked  = getBool("days",  true);
document.getElementById("show-hours").checked = getBool("hours", true);
document.getElementById("show-mins").checked  = getBool("mins",  true);
document.getElementById("show-secs").checked  = getBool("secs",  true);

// 顏色控制
const defaultColor = "#000000";
const colorParam = urlParams.get("color");
const timerColor = colorParam ? colorParam : defaultColor;

// ---- 時間參數 t=25m 解析 ----
function parseTimeString(str) {
    if (!str) return null;
    let total = 0;
    let regex = /(\d+)(d|h|m|s)/g;
    let match;

    while ((match = regex.exec(str)) !== null) {
        let value = parseInt(match[1]);
        let unit = match[2];

        if (unit === "d") total += value * 86400;
        if (unit === "h") total += value * 3600;
        if (unit === "m") total += value * 60;
        if (unit === "s") total += value;
    }
    return total > 0 ? total : null;
}

const timeParam = urlParams.get("t");
const autoStartSeconds = parseTimeString(timeParam);

// ---- 暫停控制 ----
const pauseParam = urlParams.get("pause");
const shouldPause = pauseParam === "1";

///// ========== 啟動流程 ========== /////

// 若 URL 指定倒數時間 → 自動啟動
if (autoStartSeconds) {
    remaining = autoStartSeconds;
    updateDisplay();
    startTimer();
}

// 若 URL 要求暫停
if (shouldPause) {
    clearInterval(timer);
    timer = null;
}

///// ========== 原本按鈕功能 ========== /////
document.getElementById("start-btn").onclick = () => {
    let min = parseInt(document.getElementById("input-min").value, 10);
    if (!isNaN(min) && min >= 0) {
        remaining = min * 60;
        updateDisplay();
    }
    startTimer();
};

document.getElementById("pause-btn").onclick = () => {
    clearInterval(timer);
    timer = null;
};

document.getElementById("reset-btn").onclick = () => {
    clearInterval(timer);
    timer = null;
    remaining = 0;
    updateDisplay();
};

["show-days", "show-hours", "show-mins", "show-secs"]
    .forEach(id => document.getElementById(id).addEventListener("change", updateDisplay));

updateDisplay();

</script>
